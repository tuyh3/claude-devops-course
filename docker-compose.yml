# docker-compose.yml
# Docker Compose 配置文件
# 版本: 3.8

version: '3.8'

# ==================== 网络配置 ====================
networks:
  app-network:
    driver: bridge

# ==================== 数据卷配置 ====================
volumes:
  # Oracle 数据卷
  oracle-data:
    driver: local

  # PostgreSQL 数据卷（可选，用于开发/测试）
  postgres-data:
    driver: local

  # Redis 数据卷
  redis-data:
    driver: local

  # 应用日志卷
  app-logs:
    driver: local

# ==================== 服务配置 ====================
services:

  # ==================== Spring Boot 应用 ====================
  app:
    # 使用本地构建的镜像或从仓库拉取
    image: ${DOCKER_REGISTRY:-registry.example.com}/claude-devops-course:${IMAGE_TAG:-latest}
    container_name: claude-devops-course-app

    # 构建配置（如果需要本地构建）
    build:
      context: .
      dockerfile: Dockerfile
      args:
        BUILD_NUMBER: ${BUILD_NUMBER:-local}
        GIT_COMMIT: ${GIT_COMMIT:-unknown}
        BUILD_DATE: ${BUILD_DATE:-unknown}

    # 端口映射
    ports:
      - "${APP_PORT:-8080}:8080"

    # 环境变量
    environment:
      # Spring Boot 配置
      SPRING_PROFILES_ACTIVE: ${SPRING_PROFILES_ACTIVE:-prod}

      # 数据库配置（Oracle）
      SPRING_DATASOURCE_URL: ${DB_URL:-jdbc:oracle:thin:@oracle:1521:ORCL}
      SPRING_DATASOURCE_USERNAME: ${DB_USERNAME:-system}
      SPRING_DATASOURCE_PASSWORD: ${DB_PASSWORD:-oracle}

      # Redis 配置
      SPRING_REDIS_HOST: redis
      SPRING_REDIS_PORT: 6379
      SPRING_REDIS_PASSWORD: ${REDIS_PASSWORD:-}

      # JVM 配置
      JAVA_OPTS: >-
        -Xms512m
        -Xmx1024m
        -XX:+UseG1GC
        -XX:MaxGCPauseMillis=200
        -XX:+HeapDumpOnOutOfMemoryError
        -XX:HeapDumpPath=/var/log/app
        -Dfile.encoding=UTF-8
        -Duser.timezone=Asia/Shanghai

      # 应用配置
      SERVER_PORT: 8080
      LOGGING_LEVEL_ROOT: ${LOG_LEVEL:-INFO}
      LOGGING_FILE_NAME: /var/log/app/application.log

      # ELK Stack 配置（连接到独立部署的 Logstash）
      LOGSTASH_HOST: ${LOGSTASH_HOST:-localhost}
      LOGSTASH_PORT: ${LOGSTASH_PORT:-5000}

    # 数据卷挂载
    volumes:
      - app-logs:/var/log/app
      # 配置文件挂载（可选）
      - ./config:/app/config:ro

    # 依赖服务
    depends_on:
      - redis
      # - oracle  # 如果使用容器化的 Oracle

    # 网络配置
    networks:
      - app-network

    # 健康检查
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 40s

    # 重启策略
    restart: unless-stopped

    # 日志配置
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ==================== Redis 缓存 ====================
  redis:
    image: redis:7.0-alpine
    container_name: claude-devops-course-redis

    # 端口映射（生产环境建议不暴露）
    ports:
      - "${REDIS_PORT:-6379}:6379"

    # 命令（启用持久化）
    command: >
      redis-server
      --appendonly yes
      --requirepass ${REDIS_PASSWORD:-redis123}
      --maxmemory 256mb
      --maxmemory-policy allkeys-lru

    # 数据卷
    volumes:
      - redis-data:/data

    # 网络
    networks:
      - app-network

    # 健康检查
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 3

    # 重启策略
    restart: unless-stopped

  # ==================== Oracle 数据库（可选）====================
  # 注意：Oracle 镜像需要从 Oracle Container Registry 拉取
  # 或使用 PostgreSQL 作为替代（见下方配置）
  # oracle:
  #   image: container-registry.oracle.com/database/enterprise:19.3.0.0
  #   container_name: claude-devops-course-oracle
  #
  #   ports:
  #     - "1521:1521"
  #     - "5500:5500"
  #
  #   environment:
  #     ORACLE_SID: ORCL
  #     ORACLE_PDB: ORCLPDB1
  #     ORACLE_PWD: ${ORACLE_PASSWORD:-Oracle123}
  #     ORACLE_CHARACTERSET: AL32UTF8
  #
  #   volumes:
  #     - oracle-data:/opt/oracle/oradata
  #
  #   networks:
  #     - app-network
  #
  #   restart: unless-stopped

  # ==================== PostgreSQL 数据库（开发/测试环境替代方案）====================
  postgres:
    image: postgres:16-alpine
    container_name: claude-devops-course-postgres

    ports:
      - "${POSTGRES_PORT:-5432}:5432"

    environment:
      POSTGRES_DB: ${POSTGRES_DB:-devopsdb}
      POSTGRES_USER: ${POSTGRES_USER:-devops}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres123}
      POSTGRES_INITDB_ARGS: "--encoding=UTF8 --locale=C"

    volumes:
      - postgres-data:/var/lib/postgresql/data
      # 初始化脚本
      - ./docker/postgres/init:/docker-entrypoint-initdb.d:ro

    networks:
      - app-network

    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-devops}"]
      interval: 10s
      timeout: 5s
      retries: 5

    restart: unless-stopped

  # ==================== Nginx 反向代理（可选）====================
  nginx:
    image: nginx:1.25-alpine
    container_name: claude-devops-course-nginx

    ports:
      - "${NGINX_HTTP_PORT:-80}:80"
      - "${NGINX_HTTPS_PORT:-443}:443"

    volumes:
      # Nginx 配置
      - ./docker/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./docker/nginx/conf.d:/etc/nginx/conf.d:ro
      # SSL 证书（如果使用 HTTPS）
      - ./docker/nginx/ssl:/etc/nginx/ssl:ro
      # 日志
      - ./docker/nginx/logs:/var/log/nginx

    depends_on:
      - app

    networks:
      - app-network

    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 3s
      retries: 3

    restart: unless-stopped

  # ==================== Prometheus 监控（可选）====================
  prometheus:
    image: prom/prometheus:latest
    container_name: claude-devops-course-prometheus

    ports:
      - "${PROMETHEUS_PORT:-9090}:9090"

    volumes:
      - ./docker/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./docker/prometheus/data:/prometheus

    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'

    networks:
      - app-network

    restart: unless-stopped

  # ==================== Grafana 可视化（可选）====================
  grafana:
    image: grafana/grafana:latest
    container_name: claude-devops-course-grafana

    ports:
      - "${GRAFANA_PORT:-3000}:3000"

    environment:
      GF_SECURITY_ADMIN_USER: ${GRAFANA_USER:-admin}
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_PASSWORD:-admin}
      GF_INSTALL_PLUGINS: grafana-clock-panel,grafana-simple-json-datasource

    volumes:
      - ./docker/grafana/data:/var/lib/grafana
      - ./docker/grafana/provisioning:/etc/grafana/provisioning:ro

    depends_on:
      - prometheus

    networks:
      - app-network

    restart: unless-stopped
